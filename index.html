<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂÇ¨Áú†APP</title>
    <style>
        /* ===========================================
           BASIC LAYOUT STYLES
           =========================================== */
        
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }
        
        body {
            padding: 0;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', 'Microsoft YaHei', 'ÂæÆËΩØÈõÖÈªë', 'PingFang SC', 'Hiragino Sans', sans-serif;
            box-sizing: border-box;
        }
        
        /* Phone Screen - Responsive Design */
        .phone-screen {
            width: 100vw;
            height: 100vh;
            background: #000;
            border-radius: 0;
            overflow: visible;
            position: relative;
            box-shadow: none;
        }
        
        /* Top Status Bar */
        .status-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            z-index: 10;
        }
        
        /* Application Title Bar */
        .app-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: clamp(50px, 10%, 80px);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.6) 0%, rgba(118, 75, 162, 0.6) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(16px, 4vw, 28px);
            font-weight: 600;
            letter-spacing: 1px;
            z-index: 100;
            box-shadow: 
                0 8px 32px rgba(102, 126, 234, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Shader Container */
        #container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            padding: 0;
        }
        
        canvas {
            width: 100% !important;
            height: 100% !important;
            border-radius: 15px;
            box-shadow: 
                0 0 30px rgba(128, 0, 255, 0.5),
                inset 0 0 20px rgba(255, 255, 255, 0.1);
            border: none;
            display: block;
        }
        
        /* ===========================================
           CONTROL PANEL & INPUTS
           =========================================== */
        
        /* Control Panel */
        .controls {
            margin-top: 15px;
            color: white;
            max-height: 180px;
            overflow-y: auto;
            padding: 0 clamp(8px, 2vw, 16px);
        }
        
        .control-group {
            margin: clamp(6px, 1.5vw, 12px) 0;
            display: block;
            width: 100%;
        }
        
        label {
            display: block;
            margin-bottom: clamp(3px, 1vw, 8px);
            color: #ccc;
            font-size: clamp(11px, 2vw, 16px);
            font-weight: 600;
        }
        
        input[type="range"] {
            width: 100%;
            height: clamp(3px, 0.5vw, 6px);
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: clamp(12px, 2vw, 18px);
            height: clamp(12px, 2vw, 18px);
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
        }
        
        .value-display {
            color: #9f6fff;
            font-weight: 700;
            font-size: clamp(10px, 1.8vw, 14px);
        }
        
        /* ===========================================
           BUTTON STYLES
           =========================================== */        /* Bottom Left Settings Button */
        .settings-gear-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: auto;
            height: auto;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            box-shadow: none;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 998;
            overflow: visible;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        .settings-gear-btn:hover {
            transform: scale(1.15);
        }
        
        .settings-gear-btn:active {
            transform: scale(0.95);
        }
        
        /* Mobile Touch Feedback */
        @media (hover: none) and (pointer: coarse) {
            .settings-gear-btn:active {
                transform: scale(0.98);
            }
        }

        /* Remove Blue Border on Button Click */
        button {
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        button:focus {
            outline: none;
        }

        /* Gear SVG Styles */
        .gear-svg {
            width: 48px;
            height: 48px;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), filter 0.3s ease;
            filter: drop-shadow(0 0 8px rgba(102, 126, 234, 0.6));
        }

        .settings-gear-btn:hover .gear-svg {
            transform: rotate(-20deg);
            filter: drop-shadow(0 0 16px rgba(102, 126, 234, 0.9)) drop-shadow(0 0 24px rgba(128, 0, 255, 0.6));
        }

        .settings-gear-btn:active .gear-svg {
            transform: rotate(-30deg);
            filter: drop-shadow(0 0 12px rgba(102, 126, 234, 0.7));
        }
        
        /* Localization Button - Bottom Right */
        .localization-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: auto;
            height: auto;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: none;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 998;
            overflow: visible;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            text-shadow: 0 0 8px rgba(102, 126, 234, 0.6);
        }
        
        .localization-btn:hover {
            transform: scale(1.15);
            text-shadow: 0 0 16px rgba(102, 126, 234, 0.9), 0 0 24px rgba(128, 0, 255, 0.6);
        }
        
        .localization-btn:active {
            transform: scale(0.95);
            text-shadow: 0 0 12px rgba(102, 126, 234, 0.7);
        }
        
        /* Mobile Touch Feedback */
        @media (hover: none) and (pointer: coarse) {
            .localization-btn:active {
                transform: scale(0.98);
            }
        }
        
        /* Localization Menu */
        .localization-menu {
            display: none;
        }
        
        .localization-menu.active {
            display: none;
        }
        
        /* Start Hypnosis Button */
        .hypnosis-btn {
            position: fixed;
            bottom: 20%;
            left: 50%;
            transform: translate(-50%, 50%);
            width: 120px;   
            height: 120px;  
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 4px solid rgba(255, 255, 255, 0.5);
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 
                0 16px 50px rgba(102, 126, 234, 0.8),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                0 0 40px rgba(128, 0, 255, 0.5);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 999;
            overflow: visible;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ===========================================
           RESPONSIVE DESIGN - HYPNOSIS BUTTON
           =========================================== */
        
        /* Small Screen Devices (Mobile Portrait) */
        @media screen and (max-width: 480px) {
            .hypnosis-btn {
                width: 100px;
                height: 100px;
                font-size: 14px;
            }
        }

        /* Medium Screen Devices (Mobile Landscape/Small Tablet) */
        @media screen and (min-width: 481px) and (max-width: 768px) {
            .hypnosis-btn {
                width: 120px;
                height: 120px;
                font-size: 16px;
            }
        }

        /* Large Screen Devices (Tablet/Desktop) */
        @media screen and (min-width: 769px) and (max-width: 1024px) {
            .hypnosis-btn {
                width: 140px;
                height: 140px;
                font-size: 18px;
            }
        }

        /* Extra Large Screen Devices (Large Desktop) */
        @media screen and (min-width: 1025px) {
            .hypnosis-btn {
                width: 160px;
                height: 160px;
                font-size: 20px;
            }
        }
        
        .hypnosis-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            pointer-events: none;
        }
        
        .hypnosis-btn:hover {
            transform: translate(-50%, 50%) scale(1.1);
            box-shadow: 
                0 20px 60px rgba(102, 126, 234, 0.7),
                inset 0 1px 0 rgba(255, 255, 255, 0.4),
                0 0 50px rgba(128, 0, 255, 0.5);
        }
        
        .hypnosis-btn:active {
            transform: translate(-50%, 50%) scale(0.95);
            box-shadow: 
                0 8px 25px rgba(102, 126, 234, 0.4),
                inset 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        /* Mobile Touch Feedback */
        @media (hover: none) and (pointer: coarse) {
            .hypnosis-btn:active {
                transform: translate(-50%, 50%) scale(0.98);
            }
        }

        /* Forced Climax Button */
        .climax-btn {
            position: fixed;
            bottom: 5%;
            left: 50%;
            transform: translateX(-50%);
            width: 180px;
            height: 50px;
            border-radius: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 2px solid rgba(255, 255, 255, 0.4);
            color: white;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 
                0 8px 25px rgba(102, 126, 234, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                0 0 20px rgba(128, 0, 255, 0.4);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 998;
            overflow: visible;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
        }

        /* Small Screen Devices (Mobile Portrait) */
        @media screen and (max-width: 480px) {
            .climax-btn {
                width: 140px;
                height: 40px;
                font-size: 12px;
            }
        }

        /* Medium Screen Devices (Mobile Landscape/Small Tablet) */
        @media screen and (min-width: 481px) and (max-width: 768px) {
            .climax-btn {
                width: 160px;
                height: 45px;
                font-size: 13px;
            }
        }

        /* Large Screen Devices (Tablet/Desktop) */
        @media screen and (min-width: 769px) and (max-width: 1024px) {
            .climax-btn {
                width: 180px;
                height: 50px;
                font-size: 14px;
            }
        }

        /* Extra Large Screen Devices (Large Desktop) */
        @media screen and (min-width: 1025px) {
            .climax-btn {
                width: 200px;
                height: 55px;
                font-size: 15px;
            }
        }

        /* Button Display State (When Hypnosis is Active) */
        .climax-btn.active {
            opacity: 1;
            pointer-events: all;
        }

        .climax-btn:hover {
            transform: translateX(-50%) scale(1.08);
            box-shadow: 
                0 12px 35px rgba(102, 126, 234, 0.8),
                inset 0 1px 0 rgba(255, 255, 255, 0.4),
                0 0 30px rgba(128, 0, 255, 0.6);
        }

        .climax-btn:active {
            transform: translateX(-50%) scale(0.95);
            box-shadow: 
                0 4px 15px rgba(102, 126, 234, 0.4),
                inset 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* Mobile Touch Feedback */
        @media (hover: none) and (pointer: coarse) {
            .climax-btn:active {
                transform: translateX(-50%) scale(0.97);
            }
        }
        
        /* ===========================================
           ANIMATIONS & EFFECTS
           =========================================== */
        
        /* Start Hypnosis Button Animation */
        @keyframes hypnosisActivate {
            0% {
                opacity: 0;
                transform: translate(-50%, 50%) scale(1.2);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, 50%) scale(1);
            }
        }
        
        .hypnosis-btn.activating {
            animation: hypnosisActivate 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        /* Forced Climax Pulse Animation */
        @keyframes climaxPulse {
            0% {
                transform: translateX(-50%) scale(1);
                box-shadow: 
                    0 12px 35px rgba(102, 126, 234, 0.6),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3),
                    0 0 30px rgba(128, 0, 255, 0.4);
            }
            50% {
                transform: translateX(-50%) scale(1.25);
                box-shadow: 
                    0 25px 70px rgba(102, 126, 234, 0.9),
                    inset 0 1px 0 rgba(255, 255, 255, 0.5),
                    0 0 80px rgba(128, 0, 255, 0.8);
            }
            100% {
                transform: translateX(-50%) scale(1);
                box-shadow: 
                    0 12px 35px rgba(102, 126, 234, 0.6),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3),
                    0 0 30px rgba(128, 0, 255, 0.4);
            }
        }
        
        /* Custom Scrollbar */
        .controls::-webkit-scrollbar {
            width: 4px;
        }
        
        .controls::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }
        
        .controls::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.6);
            border-radius: 2px;
        }
        
        /* ===========================================
           MODAL & DIALOGS
           =========================================== */
        
        /* Floating Settings Menu */
        .settings-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: clamp(280px, 90vw, 500px);
            max-height: clamp(400px, 80vh, 800px);
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid rgba(102, 126, 234, 0.5);
            border-radius: clamp(16px, 3vw, 28px);
            box-shadow: 
                0 0 40px rgba(102, 126, 234, 0.4),
                0 0 80px rgba(128, 0, 255, 0.25),
                0 20px 60px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(15px);
            animation: slideIn 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
        }
        
        .settings-modal.active {
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: clamp(12px, 3vw, 24px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            flex-shrink: 0;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: clamp(16px, 3vw, 24px);
            font-weight: 700;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: clamp(18px, 3vw, 28px);
            cursor: pointer;
            padding: 0;
            width: clamp(28px, 5vw, 40px);
            height: clamp(28px, 5vw, 40px);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-radius: 50%;
        }
        
        .close-btn:hover {
            transform: scale(1.15) rotate(90deg);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }
        
        .modal-content {
            overflow-y: auto;
            padding: clamp(12px, 3vw, 24px);
            flex: 1;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -45%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }
        
        /* Semi-transparent Background */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            backdrop-filter: blur(3px);
        }
        
        .modal-overlay.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="phone-screen">
            
            <!-- Application Title Bar -->
            <div class="app-header">
                ÂÇ¨Áú†APP
            </div>
            
            <!-- Main Content Area -->
            <div id="container">
                <canvas id="glCanvas" width="500" height="500"></canvas>
            </div>
            
            <!-- Modal Background -->
            <div id="modalOverlay" class="modal-overlay" onclick="closeSettings()"></div>
            
            <!-- Bottom Left Settings Button -->
            <button class="settings-gear-btn" onclick="toggleSettings()" title="ËÆæÁΩÆ">
                <svg class="gear-svg" viewBox="0 0 200 200">
                    <defs>
                        <linearGradient id="gearGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#764ba2;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#667eea;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#a78bfa;stop-opacity:1" />
                        </linearGradient>
                        <filter id="gearGlow">
                            <feGaussianBlur stdDeviation="1.5" result="coloredBlur"/>
                            <feMerge>
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                    </defs>
                    
                    <!-- 16 Gear Teeth -->
                    <g fill="url(#gearGradient)" filter="url(#gearGlow)">
                        <rect x="92" y="20" width="16" height="18" rx="2"/>
                        <g transform="rotate(22.5 100 100)">
                            <rect x="92" y="20" width="16" height="18" rx="2"/>
                        </g>
                        <!-- Upper Right Offset -->
                        <g transform="rotate(45 100 100)">
                            <rect x="92" y="20" width="16" height="18" rx="2"/>
                        </g>
                        <!-- Right -->
                        <g transform="rotate(67.5 100 100)">
                            <rect x="92" y="20" width="16" height="18" rx="2"/>
                        </g>
                        <!-- Lower Right Offset -->
                        <g transform="rotate(90 100 100)">
                            <rect x="92" y="20" width="16" height="18" rx="2"/>
                        </g>
                        <!-- Lower Right -->
                        <g transform="rotate(112.5 100 100)">
                            <rect x="92" y="20" width="16" height="18" rx="2"/>
                        </g>
                        <!-- Lower Right Offset -->
                        <g transform="rotate(135 100 100)">
                            <rect x="92" y="20" width="16" height="18" rx="2"/>
                        </g>
                        <!-- Down -->
                        <g transform="rotate(157.5 100 100)">
                            <rect x="92" y="20" width="16" height="18" rx="2"/>
                        </g>
                        <!-- Lower Left Offset -->
                        <g transform="rotate(180 100 100)">
                            <rect x="92" y="20" width="16" height="18" rx="2"/>
                        </g>
                        <!-- Lower Left -->
                        <g transform="rotate(202.5 100 100)">
                            <rect x="92" y="20" width="16" height="18" rx="2"/>
                        </g>
                        <!-- Left Offset -->
                        <g transform="rotate(225 100 100)">
                            <rect x="92" y="20" width="16" height="18" rx="2"/>
                        </g>
                        <!-- Upper Left Offset -->
                        <g transform="rotate(247.5 100 100)">
                            <rect x="92" y="20" width="16" height="18" rx="2"/>
                        </g>
                        <!-- Left -->
                        <g transform="rotate(270 100 100)">
                            <rect x="92" y="20" width="16" height="18" rx="2"/>
                        </g>
                        <!-- Upper Left -->
                        <g transform="rotate(292.5 100 100)">
                            <rect x="92" y="20" width="16" height="18" rx="2"/>
                        </g>
                        <!-- Upper Left Offset -->
                        <g transform="rotate(315 100 100)">
                            <rect x="92" y="20" width="16" height="18" rx="2"/>
                        </g>
                        <!-- Upper Offset -->
                        <g transform="rotate(337.5 100 100)">
                            <rect x="92" y="20" width="16" height="18" rx="2"/>
                        </g>
                        
                        <!-- Gear Main Disk -->
                        <circle cx="100" cy="100" r="55" fill="url(#gearGradient)"/>
                    </g>
                    
                    <!-- Center Hole -->
                    <circle cx="100" cy="100" r="20" fill="#1a1a2e"/>
                    
                    <!-- Center Decorative Ring -->
                    <circle cx="100" cy="100" r="20" fill="none" stroke="#667eea" stroke-width="2.5"/>
                    
                    <!-- Center Bright Spot -->
                    <circle cx="100" cy="100" r="12" fill="none" stroke="white" stroke-width="1" opacity="0.5"/>
                    
                    <!-- Center Dot -->
                    <circle cx="100" cy="100" r="4" fill="#a78bfa"/>
                </svg>
            </button>
            
            <!-- Floating Menu -->
            <div id="settingsModal" class="settings-modal">
                <div class="modal-header">
                    <h2>‚öôÔ∏è ËÆæÁΩÆ</h2>
                    <button class="close-btn" onclick="closeSettings()">‚úï</button>
                </div>
                <div class="modal-content">
                    <div class="control-group">
                        <label>Ëû∫ÊóãËáÇ: <span class="value-display" id="armsValue">6.0</span></label>
                        <input type="range" id="spiralArms" min="1" max="8" step="1.0" value="6.0">
                    </div>
                    
                    <div class="control-group">
                        <label>Èó¥Ë∑ù: <span class="value-display" id="spacingValue">4.0</span></label>
                        <input type="range" id="spiralSpacing" min="1" max="8" step="0.1" value="4.0">
                    </div>
                    
                    <div class="control-group">
                        <label>Ëû∫ÊóãÂº∫Â∫¶: <span class="value-display" id="spiralGlowValue">0.02</span></label>
                        <input type="range" id="spiralGlow" min="0.01" max="1" step="0.01" value="0.02">
                    </div>
                    
                    <div class="control-group">
                        <label>ÂÖâÁéØÂº∫Â∫¶: <span class="value-display" id="rippleGlowValue">1.0</span></label>
                        <input type="range" id="rippleGlow" min="0.1" max="3" step="0.1" value="1.0">
                    </div>
                    
                    <div class="control-group">
                        <label>ÂÖâÁéØÈÄüÂ∫¶: <span class="value-display" id="rippleSpeedValue">4.0</span></label>
                        <input type="range" id="rippleSpeed" min="-10" max="10" step="0.1" value="4.0">
                    </div>
                    
                    <div class="control-group">
                        <label>ÈÄüÂ∫¶: <span class="value-display" id="speedValue">2.0</span></label>
                        <input type="range" id="rotationSpeed" min="0" max="6" step="0.1" value="2.0">
                    </div>
                    
                    <div class="control-group" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.2);">
                        <label>ËØ≠Ë®Ä: <span class="value-display" id="languageDisplay">Êó•Êú¨Ë™û</span></label>
                        <div style="display: flex; gap: 8px; margin-top: 8px;">
                            <button onclick="switchLanguage('ja')" style="flex: 1; padding: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: 2px solid rgba(102, 126, 234, 0.5); border-radius: 6px; color: white; font-weight: 600; cursor: pointer; font-size: 12px; transition: all 0.3s;">
                                Êó•Êú¨Ë™û
                            </button>
                            <button onclick="switchLanguage('en')" style="flex: 1; padding: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: 2px solid rgba(102, 126, 234, 0.5); border-radius: 6px; color: white; font-weight: 600; cursor: pointer; font-size: 12px; transition: all 0.3s;">
                                English
                            </button>
                            <button onclick="switchLanguage('zh')" style="flex: 1; padding: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: 2px solid rgba(102, 126, 234, 0.5); border-radius: 6px; color: white; font-weight: 600; cursor: pointer; font-size: 12px; transition: all 0.3s;">
                                ‰∏≠Êñá
                            </button>
                        </div>
                    </div>
                    
                    <div class="control-group" style="margin-top: 15px;">
                        <button onclick="resetAllSettings()" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #ff6b6b 0%, #ff8787 100%); border: none; border-radius: 8px; color: white; font-weight: 700; cursor: pointer; font-size: 14px; transition: all 0.3s;">
                            üîÑ ÈáçÁΩÆÊâÄÊúâËÆæÁΩÆ
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Start Hypnosis Button -->
            <button class="hypnosis-btn" onclick="toggleHypnosis()" id="hypnosisBtn">ÂÇ¨Áú†„ÇíÈñãÂßã</button>
            
            <!-- Forced Climax Button -->
            <button class="climax-btn" onclick="triggerClimaxEffect()" title="Âº∑Âà∂„Ç™„É´„Ç¨„Çπ„É†" id="climaxBtn">Âº∑Âà∂„Ç™„É´„Ç¨„Çπ„É†</button>
        </div>
    </div>

    <script>
        /* ================================================================
           LOCALIZATION SYSTEM
           ================================================================ */
        
        // Localization system
        const translations = {
            ja: {
                appTitle: 'ÂÇ¨Áú†APP',
                settings: '‚öôÔ∏è Ë®≠ÂÆö',
                startHypnosis: 'ÂÇ¨Áú†ÈñãÂßã',
                endHypnosis: 'ÂÇ¨Áú†ÁµÇ‰∫Ü',
                climax: 'Âº∑Âà∂Áµ∂È†Ç',
                resetAll: 'üîÑ „Åô„Åπ„Å¶„ÅÆË®≠ÂÆö„Çí„É™„Çª„ÉÉ„Éà',
                spiralArms: '„Çπ„Éë„Ç§„É©„É´„Ç¢„Éº„É†:',
                spacing: 'ÈñìÈöî:',
                spiralIntensity: '„Çπ„Éë„Ç§„É©„É´Âº∑Â∫¶:',
                rippleIntensity: 'Ê≥¢Á¥ãÂº∑Â∫¶:',
                rippleSpeed: 'Ê≥¢Á¥ãÈÄüÂ∫¶:',
                speed: 'ÈÄüÂ∫¶:',
                language: 'Ë®ÄË™û'
            },
            en: {
                appTitle: 'Hypnosis APP',
                settings: '‚öôÔ∏è Settings',
                startHypnosis: 'Start Hypnosis',
                endHypnosis: 'End Hypnosis',
                climax: 'Forced Climax',
                resetAll: 'üîÑ Reset All Settings',
                spiralArms: 'Spiral Arms:',
                spacing: 'Spacing:',
                spiralIntensity: 'Spiral Intensity:',
                rippleIntensity: 'Ripple Intensity:',
                rippleSpeed: 'Ripple Speed:',
                speed: 'Speed:',
                language: 'Language'
            },
            zh: {
                appTitle: 'ÂÇ¨Áú†APP',
                settings: '‚öôÔ∏è ËÆæÁΩÆ',
                startHypnosis: 'ÂºÄÂßãÂÇ¨Áú†',
                endHypnosis: 'ÁªìÊùüÂÇ¨Áú†',
                climax: 'Âº∫Âà∂È´òÊΩÆ',
                resetAll: 'üîÑ ÈáçÁΩÆÊâÄÊúâËÆæÁΩÆ',
                spiralArms: 'Ëû∫ÊóãËáÇ:',
                spacing: 'Èó¥Ë∑ù:',
                spiralIntensity: 'Ëû∫ÊóãÂº∫Â∫¶:',
                rippleIntensity: 'ÂÖâÁéØÂº∫Â∫¶:',
                rippleSpeed: 'ÂÖâÁéØÈÄüÂ∫¶:',
                speed: 'ÈÄüÂ∫¶:',
                language: 'ËØ≠Ë®Ä'
            }
        };
        
        let currentLanguage = 'ja'; // Default language is Japanese
        
        // Update UI text based on current language
        function updateLanguage() {
            const t = translations[currentLanguage];
            
            // Update app header
            const appHeader = document.querySelector('.app-header');
            if (appHeader) appHeader.textContent = t.appTitle;
            
            // Update settings modal title
            const settingsTitle = document.querySelector('.modal-header h2');
            if (settingsTitle) settingsTitle.textContent = t.settings;
            
            // Update buttons
            const hypnosisBtn = document.getElementById('hypnosisBtn');
            const climaxBtn = document.getElementById('climaxBtn');
            if (hypnosisBtn) hypnosisBtn.textContent = isHypnosisActive ? t.endHypnosis : t.startHypnosis;
            if (climaxBtn) climaxBtn.textContent = t.climax;
            
            // Update language display in settings
            const languageNames = { ja: 'Êó•Êú¨Ë™û', en: 'English', zh: '‰∏≠Êñá' };
            const languageDisplay = document.getElementById('languageDisplay');
            if (languageDisplay) languageDisplay.textContent = languageNames[currentLanguage] || 'Êó•Êú¨Ë™û';
            
            // Update control labels
            const labels = document.querySelectorAll('.control-group label');
            const labelTexts = [t.spiralArms, t.spacing, t.spiralIntensity, t.rippleIntensity, t.rippleSpeed, t.speed, t.language];
            labels.forEach((label, index) => {
                if (index < labelTexts.length && index !== 6) { // Skip language label (it's handled separately)
                    const valueSpan = label.querySelector('.value-display');
                    const currentValue = valueSpan ? valueSpan.textContent : '';
                    label.innerHTML = `${labelTexts[index]} <span class="value-display">${currentValue}</span>`;
                }
            });
            
            // Update reset button
            const resetBtn = document.querySelector('[onclick="resetAllSettings()"]');
            if (resetBtn) resetBtn.textContent = t.resetAll;
            
            // Save language preference
            try {
                localStorage.setItem('preferredLanguage', currentLanguage);
            } catch (e) {
                console.warn('Failed to save language preference:', e);
            }
        }
        
        // Switch to a different language
        window.switchLanguage = function(lang) {
            if (translations[lang]) {
                currentLanguage = lang;
                updateLanguage();
            }
        };
        
        // Load saved language preference on page load
        function loadLanguagePreference() {
            try {
                const saved = localStorage.getItem('preferredLanguage');
                if (saved && translations[saved]) {
                    currentLanguage = saved;
                }
            } catch (e) {
                console.warn('Failed to load language preference:', e);
            }
            updateLanguage();
        }
        
        // Global error handling
        window.addEventListener('error', function(event) {
            console.error('‚ùå JavaScript error:', event.message);
            console.error('File:', event.filename);
            console.error('Line number:', event.lineno);
            console.error('Column number:', event.colno);
            console.error('Full error:', event.error);
        });
        
        /* ================================================================
           WEBGL INITIALIZATION & SHADERS
           ================================================================ */
        
        // Vertex shader
        const vertexShaderSource = `
            attribute vec4 aVertexPosition;
            void main() {
                gl_Position = aVertexPosition;
            }
        `;

        // Fragment shader
        const fragmentShaderSource = `
            #ifdef GL_ES
            precision mediump float;
            #endif

            uniform vec2 u_resolution;
            uniform float u_time;
            uniform float u_spiralArms;
            uniform float u_spiralSpacing;
            uniform float u_spiralGlow;
            uniform float u_rippleGlow;
            uniform float u_rippleSpeed;
            uniform float u_rotationSpeed;
            uniform float u_activationProgress;
            uniform float u_deactivationProgress;
            uniform float u_climaxIntensity;

            void main() {
                vec2 uv = (gl_FragCoord.xy * 2.0 - u_resolution.xy) / u_resolution.y;
                float d = length(uv);
                
                float goldenRatio = 1.618033988749895;
                float spiralAngle = u_time * u_rotationSpeed;
                vec3 spiralColor = vec3(2.0, 0.5, 3.0);
                
                vec3 rippleColor = vec3(1.5, 0.3, 2.5);
                
                vec3 climaxColor = vec3(1.0, 0.4, 0.8);
                
                float angle = atan(uv.y, uv.x);
                float goldenSpacing = pow(goldenRatio, d * u_spiralSpacing); 
                float goldenSpiral = angle * u_spiralArms * 0.5 + goldenSpacing - spiralAngle;
                float spiralPattern = sin(goldenSpiral);
                spiralPattern = abs(spiralPattern);
                float spiralIntensity = (0.4 / spiralPattern) * u_spiralGlow;
                
                float ripple = sin(d * 10.0 - u_time * u_rippleSpeed) / 10.0;
                ripple = abs(ripple);
                float rippleIntensity = (0.02 / ripple) * u_rippleGlow;
                
                float expandRadius = u_activationProgress * 3.0;
                float expandWave = smoothstep(expandRadius + 0.3, expandRadius - 0.1, d);
                
                float expandGlow = exp(-pow(d - expandRadius, 2.0) * 8.0) * (1.0 - u_activationProgress * 0.5);
                
                float shrinkRadius = 3.0 - u_deactivationProgress * 3.0;
                float shrinkWave = smoothstep(shrinkRadius + 0.3, shrinkRadius - 0.1, d);
                
                float shrinkGlow = exp(-pow(d - shrinkRadius, 2.0) * 8.0) * u_deactivationProgress;
                
                float finalWave = mix(expandWave, shrinkWave, u_deactivationProgress);
                float finalGlow = mix(expandGlow, shrinkGlow, u_deactivationProgress);
                
                float climaxPulse = sin(u_time * 15.0) * 0.5 + 0.5;
                float climaxWave = smoothstep(0.5, 0.0, d) * u_climaxIntensity * 2.5;
                float climaxGlow = exp(-d * 1.5) * climaxPulse * u_climaxIntensity * 3.0;
                
                vec3 backgroundColor = vec3(0.0, 0.0, 0.0);
                vec3 spiralPart = spiralColor * spiralIntensity * finalWave;
                vec3 ripplePart = rippleColor * rippleIntensity * finalWave;
                vec3 expandPart = (spiralColor + rippleColor) * finalGlow;
                
                vec3 finalColor = mix(
                    backgroundColor + spiralPart + ripplePart + expandPart,
                    climaxColor * (climaxWave + climaxGlow),
                    u_climaxIntensity
                );

                gl_FragColor = vec4(finalColor, 1.0);
            }
        `;

        // WebGL Initialization
        const canvas = document.getElementById('glCanvas');
        
        if (!canvas) {
            console.error('Canvas element glCanvas not found');
            throw new Error('Canvas element not found');
        }
        
        // Dynamically set canvas resolution to fit container
        function resizeCanvas() {
            const container = document.getElementById('container');
            if (!container) {
                console.error('Container element not found');
                return;
            }
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }
        
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        const gl = canvas.getContext('webgl');

        if (!gl) {
            console.error('WebGL not available');
            alert('Your browser does not support WebGL');
            throw new Error('WebGL context not available');
        }
        
        console.log('WebGL initialization successful');

        // Compile shader
        function createShader(gl, type, source) {
            const shader = gl.createShader(type);
            gl.shaderSource(shader, source);
            gl.compileShader(shader);

            if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                console.error('Shader compilation error:', gl.getShaderInfoLog(shader));
                gl.deleteShader(shader);
                return null;
            }

            return shader;
        }

        // Create shader program
        function createShaderProgram(gl, vertexSource, fragmentSource) {
            const vertexShader = createShader(gl, gl.VERTEX_SHADER, vertexSource);
            const fragmentShader = createShader(gl, gl.FRAGMENT_SHADER, fragmentSource);

            const shaderProgram = gl.createProgram();
            gl.attachShader(shaderProgram, vertexShader);
            gl.attachShader(shaderProgram, fragmentShader);
            gl.linkProgram(shaderProgram);

            if (!gl.getProgramParameter(shaderProgram, gl.LINK_STATUS)) {
                console.error('Shader program linking error:', gl.getProgramInfoLog(shaderProgram));
                return null;
            }

            return shaderProgram;
        }

        // Initialize shader program
        const shaderProgram = createShaderProgram(gl, vertexShaderSource, fragmentShaderSource);

        // Get attribute and uniform locations
        const programInfo = {
            attribLocations: {
                vertexPosition: gl.getAttribLocation(shaderProgram, 'aVertexPosition'),
            },
            uniformLocations: {
                resolution: gl.getUniformLocation(shaderProgram, 'u_resolution'),
                time: gl.getUniformLocation(shaderProgram, 'u_time'),
                spiralArms: gl.getUniformLocation(shaderProgram, 'u_spiralArms'),
                spiralSpacing: gl.getUniformLocation(shaderProgram, 'u_spiralSpacing'),
                spiralGlow: gl.getUniformLocation(shaderProgram, 'u_spiralGlow'),
                rippleGlow: gl.getUniformLocation(shaderProgram, 'u_rippleGlow'),
                rippleSpeed: gl.getUniformLocation(shaderProgram, 'u_rippleSpeed'),
                rotationSpeed: gl.getUniformLocation(shaderProgram, 'u_rotationSpeed'),
                activationProgress: gl.getUniformLocation(shaderProgram, 'u_activationProgress'),
                deactivationProgress: gl.getUniformLocation(shaderProgram, 'u_deactivationProgress'),
                climaxIntensity: gl.getUniformLocation(shaderProgram, 'u_climaxIntensity'),
            },
        };

        
        /* ================================================================
           BUFFER & CONTROL PARAMETERS
           ================================================================ */
        
        // Create buffer
        const positionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);

        const positions = [
            -1.0,  1.0,
             1.0,  1.0,
            -1.0, -1.0,
             1.0, -1.0,
        ];

        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(positions), gl.STATIC_DRAW);

        // Control parameters - Default values
        let spiralArms = 6.0;
        let spiralSpacing = 4.0;
        let spiralGlow = 0.02;
        let rippleGlow = 1.0;
        let rippleSpeed = 4.0;
        let rotationSpeed = 2.0;
        
        // For convenient access in setupControls, create a parameter map
        const paramMap = {
            spiralArms: () => spiralArms,
            spiralSpacing: () => spiralSpacing,
            spiralGlow: () => spiralGlow,
            rippleGlow: () => rippleGlow,
            rippleSpeed: () => rippleSpeed,
            rotationSpeed: () => rotationSpeed
        };

        // Auto-save current settings to localStorage
        function autoSaveSettings() {
            try {
                const preset = {
                    spiralArms,
                    spiralSpacing,
                    spiralGlow,
                    rippleGlow,
                    rippleSpeed,
                    rotationSpeed
                };
                localStorage.setItem('hypnosisSettings', JSON.stringify(preset));
            } catch (e) {
                // If localStorage is not available, fail silently
                console.warn('Failed to auto-save settings:', e);
            }
        }

        // Auto-load previously saved settings
        function autoLoadSettings() {
            try {
                const preset = localStorage.getItem('hypnosisSettings');
                if (preset) {
                    const settings = JSON.parse(preset);
                    spiralArms = settings.spiralArms !== undefined ? settings.spiralArms : spiralArms;
                    spiralSpacing = settings.spiralSpacing !== undefined ? settings.spiralSpacing : spiralSpacing;
                    spiralGlow = settings.spiralGlow !== undefined ? settings.spiralGlow : spiralGlow;
                    rippleGlow = settings.rippleGlow !== undefined ? settings.rippleGlow : rippleGlow;
                    rippleSpeed = settings.rippleSpeed !== undefined ? settings.rippleSpeed : rippleSpeed;
                    rotationSpeed = settings.rotationSpeed !== undefined ? settings.rotationSpeed : rotationSpeed;
                }
            } catch (e) {
                console.warn('Failed to auto-load settings:', e);
            }
        }

        // Restore settings when page loads
        autoLoadSettings();

        /* ================================================================
           CONTROL SETUP & UI INTERACTIONS
           ================================================================ */
        
        // Controller events
        function setupControls() {
            const controls = [
                { id: 'spiralArms', valueId: 'armsValue', variable: 'spiralArms' },
                { id: 'spiralSpacing', valueId: 'spacingValue', variable: 'spiralSpacing' },
                { id: 'spiralGlow', valueId: 'spiralGlowValue', variable: 'spiralGlow' },
                { id: 'rippleGlow', valueId: 'rippleGlowValue', variable: 'rippleGlow' },
                { id: 'rippleSpeed', valueId: 'rippleSpeedValue', variable: 'rippleSpeed' },
                { id: 'rotationSpeed', valueId: 'speedValue', variable: 'rotationSpeed' }
            ];

            controls.forEach(control => {
                const slider = document.getElementById(control.id);
                const valueDisplay = document.getElementById(control.valueId);
                
                if (!slider || !valueDisplay) {
                    console.warn(`Element not found: ${control.id} or ${control.valueId}`);
                    return;
                }
                
                // Initialize slider value to current variable value
                const currentValue = paramMap[control.variable]();
                slider.value = currentValue;
                
                // Sync display value
                if (control.variable === 'spiralGlow') {
                    valueDisplay.textContent = currentValue.toFixed(2);
                } else if (control.variable === 'rippleSpeed') {
                    // Display ripple speed with direction and description
                    const direction = currentValue > 0 ? '(Expanding)' : currentValue < 0 ? '(Contracting)' : '(Stationary)';
                    valueDisplay.textContent = `${currentValue.toFixed(1)} ${direction}`;
                } else {
                    valueDisplay.textContent = currentValue.toFixed(1);
                }
                
                slider.addEventListener('input', function() {
                    const value = parseFloat(this.value);
                    // Use more precise display format for spiral glow
                    if (control.variable === 'spiralGlow') {
                        valueDisplay.textContent = value.toFixed(2);
                    } else if (control.variable === 'rippleSpeed') {
                        // Display ripple speed with direction and description
                        const direction = value > 0 ? '(Expanding)' : value < 0 ? '(Contracting)' : '(Stationary)';
                        valueDisplay.textContent = `${value.toFixed(1)} ${direction}`;
                    } else {
                        valueDisplay.textContent = value.toFixed(1);
                    }
                    
                    switch(control.variable) {
                        case 'spiralArms': spiralArms = value; break;
                        case 'spiralSpacing': spiralSpacing = value; break;
                        case 'spiralGlow': spiralGlow = value; break;
                        case 'rippleGlow': rippleGlow = value; break;
                        case 'rippleSpeed': rippleSpeed = value; break;
                        case 'rotationSpeed': rotationSpeed = value; break;
                    }
                    
                    // Auto-save every time changes
                    autoSaveSettings();
                });
            });
        }

        // Set up controls after loading settings to ensure sliders and values are in sync
        try {
            setupControls();
        } catch (e) {
            console.error('Failed to set up controls:', e);
        }

        /* ================================================================
           APPLICATION CONTROL & STATE MANAGEMENT
           ================================================================ */
        
        // Apply control functionality
        let isPaused = false;
        let isHypnosisActive = false;
        let hypnosisStartTime = null; // Animation start time
        let hypnosisEndTime = null; // Animation end time
        let climaxStartTime = null; // Climax effect start time
        let animationId;

        // Start hypnosis button
        window.toggleHypnosis = function() {
            const hypnosisBtn = document.querySelector('.hypnosis-btn');
            isHypnosisActive = !isHypnosisActive;
            const t = translations[currentLanguage];
            hypnosisBtn.textContent = isHypnosisActive ? t.endHypnosis : t.startHypnosis;
            
            // Manage the visibility of the forced climax button
            const climaxBtn = document.querySelector('.climax-btn');
            if (isHypnosisActive) {
                climaxBtn.classList.add('active');
            } else {
                climaxBtn.classList.remove('active');
            }
            
            // When activating hypnosis, reset pause state and start animation
            if (isHypnosisActive) {
                isPaused = false;
                hypnosisStartTime = null; // Reset to null, will be set to current time on next render
                hypnosisEndTime = null; // Reset end time
                
                // Add startup animation class
                hypnosisBtn.classList.add('activating');
                setTimeout(() => hypnosisBtn.classList.remove('activating'), 600);
            } else {
                // When ending hypnosis, record the time to start fade-out animation
                hypnosisEndTime = performance.now();
            }
        };

        // Forced climax effect
        window.triggerClimaxEffect = function() {
            if (!isHypnosisActive) {
                const t = translations[currentLanguage];
                const alerts = {
                    ja: 'ÂÖà„Å´ÂÇ¨Áú†„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
                    en: 'Please start hypnosis first',
                    zh: 'ËØ∑ÂÖàÂºÄÂßãÂÇ¨Áú†'
                };
                alert(alerts[currentLanguage] || alerts.en);
                return;
            }
            
            // Record the start time of the climax effect
            climaxStartTime = performance.now();
            
            const climaxBtn = document.querySelector('.climax-btn');
            
            // Trigger pulse animation
            climaxBtn.style.animation = 'none';
            setTimeout(() => {
                climaxBtn.style.animation = 'climaxPulse 0.6s cubic-bezier(0.34, 1.56, 0.64, 1)';
            }, 10);
        };

        // Settings menu control
        window.toggleSettings = function() {
            const modal = document.getElementById('settingsModal');
            const overlay = document.getElementById('modalOverlay');
            modal.classList.toggle('active');
            overlay.classList.toggle('active');
        };

        window.closeSettings = function() {
            const modal = document.getElementById('settingsModal');
            const overlay = document.getElementById('modalOverlay');
            modal.classList.remove('active');
            overlay.classList.remove('active');
        };

        // Reset all settings
        window.resetAllSettings = function() {
            // Default values
            const defaults = {
                spiralArms: 6.0,
                spiralSpacing: 4.0,
                spiralGlow: 0.02,
                rippleGlow: 1.0,
                rippleSpeed: 4.0,
                rotationSpeed: 2.0
            };
            
            // Reset all input element values
            document.getElementById('spiralArms').value = defaults.spiralArms;
            document.getElementById('spiralSpacing').value = defaults.spiralSpacing;
            document.getElementById('spiralGlow').value = defaults.spiralGlow;
            document.getElementById('rippleGlow').value = defaults.rippleGlow;
            document.getElementById('rippleSpeed').value = defaults.rippleSpeed;
            document.getElementById('rotationSpeed').value = defaults.rotationSpeed;
            
            // Update display values
            document.getElementById('armsValue').textContent = defaults.spiralArms.toFixed(1);
            document.getElementById('spacingValue').textContent = defaults.spiralSpacing.toFixed(1);
            document.getElementById('spiralGlowValue').textContent = defaults.spiralGlow.toFixed(2);
            document.getElementById('rippleGlowValue').textContent = defaults.rippleGlow.toFixed(1);
            document.getElementById('rippleSpeedValue').textContent = defaults.rippleSpeed.toFixed(1);
            document.getElementById('speedValue').textContent = defaults.rotationSpeed.toFixed(1);
            
            // Update global variables
            spiralArms = defaults.spiralArms;
            spiralSpacing = defaults.spiralSpacing;
            spiralGlow = defaults.spiralGlow;
            rippleGlow = defaults.rippleGlow;
            rippleSpeed = defaults.rippleSpeed;
            rotationSpeed = defaults.rotationSpeed;
            
            // Clear browser cache (localStorage)
            localStorage.clear();
            
            // Show reset successful feedback with localization
            const resetMessages = {
                ja: '‚úÖ „Åô„Åπ„Å¶„ÅÆË®≠ÂÆö„Åå„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„Åó„ÅüÔºÅ',
                en: '‚úÖ All settings have been reset!',
                zh: '‚úÖ ÊâÄÊúâËÆæÁΩÆÂ∑≤ÈáçÁΩÆÔºÅ'
            };
            alert(resetMessages[currentLanguage] || resetMessages.en);
        };

        // ESC key closes menu
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeSettings();
            }
        });

        /* ================================================================
           ANIMATION & RENDER LOOP
           ================================================================ */
        
        // Render loop
        let lastTime = 0;
        let pausedTime = 0;
        
        function render(time) {
            gl.viewport(0, 0, canvas.width, canvas.height);
            gl.clearColor(0.0, 0.0, 0.0, 1.0);
            gl.clear(gl.COLOR_BUFFER_BIT);

            let activationProgress = 0.0;
            let deactivationProgress = 0.0;
            
            // Calculate climax intensity (linear decay from 1.0 to 0.0 over 0.6 seconds from climaxStartTime)
            let climaxIntensity = 0.0;
            if (climaxStartTime !== null) {
                const climaxDuration = 600; // milliseconds
                const currentTime = performance.now();
                const climaxElapsed = currentTime - climaxStartTime;
                
                if (climaxElapsed < climaxDuration) {
                    // Linear decay from 1.0 to 0.0
                    climaxIntensity = Math.max(0.0, 1.0 - (climaxElapsed / climaxDuration));
                } else {
                    // Climax effect has ended
                    climaxStartTime = null;
                    climaxIntensity = 0.0;
                }
            }

            // Only draw shader when hypnosis is active
            if (isHypnosisActive) {
                // If first time activated, record start time
                if (hypnosisStartTime === null) {
                    hypnosisStartTime = time;
                    hypnosisEndTime = null;
                }

                // Calculate startup animation progress (0-1, duration 600ms)
                const activationDuration = 600; // milliseconds
                activationProgress = Math.min((time - hypnosisStartTime) / activationDuration, 1.0);

                if (!isPaused) {
                    time *= 0.001; // Convert to seconds
                    lastTime = time - pausedTime;
                } else {
                    pausedTime = (time * 0.001) - lastTime;
                }

                gl.useProgram(shaderProgram);

                // Set attributes
                gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
                gl.vertexAttribPointer(programInfo.attribLocations.vertexPosition, 2, gl.FLOAT, false, 0, 0);
                gl.enableVertexAttribArray(programInfo.attribLocations.vertexPosition);

                // Adjust parameters based on activation progress
                // Gradually increase spiral intensity, ripple intensity, etc. to create "awakening" effect
                const currentSpiralGlow = spiralGlow * activationProgress;
                const currentRippleGlow = rippleGlow * activationProgress;

                // Set uniforms
                gl.uniform2f(programInfo.uniformLocations.resolution, canvas.width, canvas.height);
                gl.uniform1f(programInfo.uniformLocations.time, lastTime);
                gl.uniform1f(programInfo.uniformLocations.spiralArms, spiralArms);
                gl.uniform1f(programInfo.uniformLocations.spiralSpacing, spiralSpacing);
                gl.uniform1f(programInfo.uniformLocations.spiralGlow, currentSpiralGlow);
                gl.uniform1f(programInfo.uniformLocations.rippleGlow, currentRippleGlow);
                gl.uniform1f(programInfo.uniformLocations.rippleSpeed, rippleSpeed);
                gl.uniform1f(programInfo.uniformLocations.rotationSpeed, rotationSpeed);
                gl.uniform1f(programInfo.uniformLocations.activationProgress, activationProgress);
                gl.uniform1f(programInfo.uniformLocations.deactivationProgress, 0.0);
                gl.uniform1f(programInfo.uniformLocations.climaxIntensity, climaxIntensity);

                gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
            } else if (hypnosisEndTime !== null) {
                // Fade-out animation after ending hypnosis
                const deactivationDuration = 600; // milliseconds
                const currentTime = performance.now();
                deactivationProgress = Math.min((currentTime - hypnosisEndTime) / deactivationDuration, 1.0);

                if (deactivationProgress < 1.0) {
                    // Animation is still in progress
                    if (!isPaused) {
                        time *= 0.001; // Convert to seconds
                        lastTime = time - pausedTime;
                    } else {
                        pausedTime = (time * 0.001) - lastTime;
                    }

                    gl.useProgram(shaderProgram);

                    // Set attributes
                    gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
                    gl.vertexAttribPointer(programInfo.attribLocations.vertexPosition, 2, gl.FLOAT, false, 0, 0);
                    gl.enableVertexAttribArray(programInfo.attribLocations.vertexPosition);

                    // Gradually weaken effects during fade-out
                    const currentSpiralGlow = spiralGlow * (1.0 - deactivationProgress);
                    const currentRippleGlow = rippleGlow * (1.0 - deactivationProgress);

                    // Set uniforms
                    gl.uniform2f(programInfo.uniformLocations.resolution, canvas.width, canvas.height);
                    gl.uniform1f(programInfo.uniformLocations.time, lastTime);
                    gl.uniform1f(programInfo.uniformLocations.spiralArms, spiralArms);
                    gl.uniform1f(programInfo.uniformLocations.spiralSpacing, spiralSpacing);
                    gl.uniform1f(programInfo.uniformLocations.spiralGlow, currentSpiralGlow);
                    gl.uniform1f(programInfo.uniformLocations.rippleGlow, currentRippleGlow);
                    gl.uniform1f(programInfo.uniformLocations.rippleSpeed, rippleSpeed);
                    gl.uniform1f(programInfo.uniformLocations.rotationSpeed, rotationSpeed);
                    gl.uniform1f(programInfo.uniformLocations.activationProgress, 1.0); // Already fully activated
                    gl.uniform1f(programInfo.uniformLocations.deactivationProgress, deactivationProgress);
                    gl.uniform1f(programInfo.uniformLocations.climaxIntensity, climaxIntensity);

                    gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
                } else {
                    // Animation complete, clear end time
                    hypnosisEndTime = null;
                }
            }

            animationId = requestAnimationFrame(render);
        }

        requestAnimationFrame(render);
        console.log('Render loop started');
        
        // Load language preference on page load
        loadLanguagePreference();
    </script>
</body>
</html>
